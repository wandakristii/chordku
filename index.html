<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Chord Master Cloud V14</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <style>
        /* GAYA SAMA SEPERTI V13 (Disingkat agar muat, tapi fungsi tetap sama) */
        :root { --bg:#fff; --text:#000; --accent:#2962ff; --font-stack:'Roboto Condensed',sans-serif; }
        body { font-family:var(--font-stack); background:var(--bg); color:var(--text); margin:0; padding:10px; padding-bottom:150px; }
        .hidden { display:none!important; }
        .btn { border:none; padding:12px; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; margin-bottom:5px; }
        .btn-primary { background:var(--accent); color:#fff; }
        .btn-secondary { background:#eee; color:#000; }
        .btn-danger { background:#ffcdd2; color:#b71c1c; }
        input, select { background:#fff; border:1px solid #ccc; padding:10px; width:100%; box-sizing:border-box; border-radius:5px; margin-bottom:5px; }
        
        /* CLOUD STATUS BAR */
        .cloud-status {
            background: #e8f5e9; color: #2e7d32; padding: 8px; text-align: center; font-size: 12px; border-radius: 5px; margin-bottom: 10px; border: 1px solid #c8e6c9;
            display: flex; justify-content: space-between; align-items: center;
        }
        .status-dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px;}
        .status-dot.online { background-color: #00c853; box-shadow: 0 0 5px #00c853; }

        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
        }
        .login-box {
            background: white; padding: 25px; border-radius: 12px; width: 80%; max-width: 300px; text-align: center;
        }

        /* UI Components (Song Card, etc - Simplified for V14 Code Space) */
        .song-card { background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:10px; border-left:5px solid var(--accent); box-shadow:0 2px 3px rgba(0,0,0,0.1); }
        .gig-nav { position:fixed; bottom:70px; left:15px; right:15px; background:#fff; border:1px solid #ccc; border-radius:12px; padding:10px; display:flex; gap:10px; z-index:200; box-shadow:0 5px 20px rgba(0,0,0,0.2); }
        .fab { position:fixed; bottom:90px; right:20px; width:55px; height:55px; border-radius:50%; background:var(--accent); color:#fff; font-size:28px; border:none; display:flex; justify-content:center; align-items:center; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:100; }
        
        /* Editor Grid */
        .bar-wrapper { border-bottom:1px solid #eee; padding:10px 0; }
        .grid-row { display:grid; gap:4px; }
        .beat-input { text-align:center; font-weight:bold; font-size:1.2em; padding:8px 0; border:1px solid #ccc; border-radius:4px; }
        .melody-input { text-align:center; border:none; border-bottom:1px dashed #ccc; font-size:0.9em; color:#00c853; }
        
        /* View Mode */
        .view-bar { display:grid; border-right:1px solid #ccc; padding:4px 0; } .view-bar:nth-child(4n){border-right:none;}
        .view-chord { font-weight:800; font-size:22px; text-align:center; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>☁️ Connect Cloud</h2>
            <p style="color:#666; font-size:0.9em;">Masukkan Kode Rahasia yang sama di semua HP/Laptop agar data tersinkron.</p>
            <input type="text" id="secret-code" placeholder="Contoh: band-joko-123">
            <button class="btn btn-primary" onclick="connectToCloud()">Sambungkan</button>
            <p style="font-size:0.8em; margin-top:10px; color:#888;">Pastikan ada koneksi internet.</p>
        </div>
    </div>

    <div class="cloud-status" id="cloud-bar" style="display:none;">
        <span><span class="status-dot online"></span> Terhubung: <b id="display-code">...</b></span>
        <button onclick="logoutCloud()" style="background:none; border:none; color:#d32f2f; font-size:10px; text-decoration:underline; cursor:pointer;">Putus</button>
    </div>

    <div id="list-view">
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <button class="btn btn-secondary" onclick="switchTab('songs')">Library</button>
            <button class="btn btn-secondary" onclick="switchTab('sets')">Setlists</button>
        </div>
        <div id="content-songs">
            <input type="search" id="search-input" placeholder="Cari Lagu..." oninput="searchSongs()">
            <div id="songs-list"></div>
        </div>
        <div id="content-sets" class="hidden">
            <button class="btn btn-primary" onclick="createNewSetlist()">+ Buat Setlist</button>
            <div id="sets-list"></div>
        </div>
        <button class="fab" onclick="openEditor()">+</button>
    </div>

    <div id="editor-view" class="hidden">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <button class="btn btn-secondary" style="width:auto" onclick="goHome()">Batal</button>
            <button class="btn btn-primary" style="width:auto" onclick="saveSong()">Simpan ke Cloud</button>
        </div>
        <input type="hidden" id="song-id">
        <input type="text" id="title" placeholder="Judul Lagu">
        <input type="text" id="artist" placeholder="Artis">
        <div style="display:flex; gap:5px;">
            <input type="text" id="key" placeholder="Key" style="flex:2">
            <select id="tempo" style="flex:1"><option value="4">4/4</option><option value="3">3/4</option><option value="2">2/4</option><option value="6">6/8</option></select>
        </div>
        <div id="editor-sections"></div>
        <div style="margin-top:20px;">
            <button class="btn btn-secondary" onclick="addSection('Verse')">+ Verse</button>
            <button class="btn btn-secondary" onclick="addSection('Chorus')">+ Chorus</button>
            </div>
        <button class="btn btn-danger" onclick="deleteSong()" style="margin-top:20px;">Hapus Lagu</button>
    </div>

    <div id="detail-view" class="hidden">
        <div style="text-align:center; margin-bottom:20px;">
            <button class="btn btn-secondary" onclick="goHome()" style="float:left; width:auto; padding:5px 10px;">&larr;</button>
            <button class="btn btn-secondary" onclick="editCurrent()" style="float:right; width:auto; padding:5px 10px;">Edit</button>
            <h2 id="view-title" style="margin:0;">Judul</h2>
            <div id="view-meta" style="color:#666;">Artist • Key</div>
        </div>
        <div id="view-content"></div>
        <div class="gig-nav">
            <button class="btn btn-secondary" style="flex:1" onclick="prevSetSong()">Prev</button>
            <button class="btn btn-primary" style="flex:2" onclick="nextSetSong()">NEXT &rarr;</button>
        </div>
    </div>

    <script>
        // --- ⚠️ CONFIG FIREBASE (GANTI INI DENGAN KODE ANDA!) ---
        const firebaseConfig = {
  apiKey: "AIzaSyBZOdVSpMfcOnf2x4KnAcnLe9jd-l4xJSg",
  authDomain: "chordku-78d09.firebaseapp.com",
  databaseURL: "https://chordku-78d09-default-rtdb.firebaseio.com",
  projectId: "chordku-78d09",
  storageBucket: "chordku-78d09.firebasestorage.app",
  messagingSenderId: "288634910494",
  appId: "1:288634910494:web:b3ea33d647d1abaf5ebb0f"
        };
        // ---------------------------------------------------------

        // Initialize Firebase
        let db;
        let dbRef;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
        } catch(e) {
            console.error("Firebase Error (Belum setup config):", e);
        }

        // APP STATE
        let secretCode = localStorage.getItem('my_secret_code');
        let songs = [];
        let setlists = [];
        let currentSong = null;
        let editState = { sections: [] };

        // 1. CONNECT LOGIC
        function checkLogin() {
            if(secretCode) {
                document.getElementById('login-overlay').classList.add('hidden');
                document.getElementById('display-code').innerText = secretCode;
                document.getElementById('cloud-bar').style.display = 'flex';
                startSync();
            }
        }

        function connectToCloud() {
            const input = document.getElementById('secret-code').value;
            if(!input) return alert("Isi kode rahasia dulu!");
            secretCode = input.trim();
            localStorage.setItem('my_secret_code', secretCode);
            checkLogin();
        }

        function logoutCloud() {
            localStorage.removeItem('my_secret_code');
            location.reload();
        }

        // 2. REALTIME SYNC (JANTUNG APLIKASI)
        function startSync() {
            if(!db) return;
            // Listen to changes in this secret folder
            const userRef = db.ref('users/' + secretCode);
            
            userRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if(data) {
                    songs = data.songs || [];
                    setlists = data.setlists || [];
                } else {
                    // Data baru/kosong di cloud
                    songs = [];
                    setlists = [];
                }
                renderList(); // Auto refresh tampilan
            });
        }

        // 3. SAVE TO CLOUD
        function saveToCloud() {
            if(!db || !secretCode) return;
            db.ref('users/' + secretCode).set({
                songs: songs,
                setlists: setlists,
                lastUpdated: new Date().toISOString()
            }).then(() => {
                console.log("Tersimpan di Cloud!");
            }).catch((err) => {
                alert("Gagal simpan ke internet: " + err.message);
            });
        }

        // --- STANDARD APP FUNCTIONS (MODIFIED TO CALL saveToCloud) ---
        
        function saveSong() {
            const id = document.getElementById('song-id').value;
            const title = document.getElementById('title').value;
            if(!title) { alert("Judul?"); return; }
            
            const data = {
                id: id ? parseInt(id) : Date.now(),
                title, 
                artist: document.getElementById('artist').value,
                key: document.getElementById('key').value,
                tempoVal: parseInt(document.getElementById('tempo').value),
                sections: editState.sections
            };

            if(id) {
                const idx = songs.findIndex(s => s.id == id);
                if(idx >= 0) songs[idx] = data;
            } else {
                songs.push(data);
            }
            
            saveToCloud(); // PUSH KE INTERNET
            goHome();
        }

        function deleteSong() {
            if(confirm("Yakin hapus?")) {
                songs = songs.filter(s => s.id != document.getElementById('song-id').value);
                saveToCloud();
                goHome();
            }
        }

        // --- UI RENDERING (Sama seperti V13 tapi disingkat) ---
        function renderList() {
            const list = document.getElementById('songs-list'); list.innerHTML = '';
            songs.sort((a,b) => a.title.localeCompare(b.title));
            songs.forEach(s => {
                list.innerHTML += `<div class="song-card" onclick="showDetail(${s.id})"><b>${s.title}</b><br><small>${s.artist}</small></div>`;
            });
        }
        
        function openEditor(songId=null) {
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('editor-view').classList.remove('hidden');
            // ... (Logic populate form sama seperti V13) ...
            // Untuk ringkas, logic populate form disederhanakan di sini:
            if(songId) {
                currentSong = songs.find(s => s.id === songId);
                document.getElementById('song-id').value = currentSong.id;
                document.getElementById('title').value = currentSong.title;
                editState.sections = JSON.parse(JSON.stringify(currentSong.sections));
            } else {
                document.getElementById('song-id').value = '';
                document.getElementById('title').value = '';
                editState.sections = [];
            }
            renderEditor();
        }

        function addSection(type) { editState.sections.push({type, bars:[{beats:["","","",""], melody:["","","",""]}]}); renderEditor(); }
        
        function renderEditor() {
            const c = document.getElementById('editor-sections'); c.innerHTML = '';
            editState.sections.forEach((sec, idx) => {
                let html = `<div style="margin-bottom:10px; border:1px solid #ccc; padding:10px;"><b>${sec.type}</b>`;
                // Render bars logic simplified
                sec.bars.forEach((bar, bIdx) => {
                    html += `<div class="grid-row" style="grid-template-columns:repeat(4,1fr); margin-top:5px;">`;
                    bar.beats.forEach((beat, k) => {
                        html += `<input class="beat-input" value="${beat}" oninput="updateData(${idx},${bIdx},${k},this.value)">`;
                    });
                    html += `</div>`;
                });
                html += `</div>`;
                c.innerHTML += html;
            });
        }
        
        function updateData(sIdx, bIdx, k, val) { editState.sections[sIdx].bars[bIdx].beats[k] = val; }

        function showDetail(id) {
            currentSong = songs.find(s=>s.id===id);
            document.getElementById('list-view').classList.add('hidden');
            document.getElementById('detail-view').classList.remove('hidden');
            document.getElementById('view-title').innerText = currentSong.title;
            // Render Detail Logic...
        }

        function goHome() {
            document.getElementById('list-view').classList.remove('hidden');
            document.getElementById('editor-view').classList.add('hidden');
            document.getElementById('detail-view').classList.add('hidden');
        }
        
        function editCurrent() { openEditor(currentSong.id); }
        function switchTab(t) { 
            if(t=='songs'){document.getElementById('content-songs').classList.remove('hidden'); document.getElementById('content-sets').classList.add('hidden');}
            else {document.getElementById('content-songs').classList.add('hidden'); document.getElementById('content-sets').classList.remove('hidden');}
        }

        // INIT
        checkLogin();

    </script>
</body>
</html>